---
// Import the global.css file here so that it is included on
// all pages through the use of the <BaseHead /> component.
import '../styles/global.css';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';

interface Props {
	title: string;
	description: string;
	image?: string;
	ogType?: 'website' | 'article';
	noindex?: boolean;
	publishedTime?: Date | string;
	modifiedTime?: Date | string;
	tags?: string[];
	structuredData?: Record<string, unknown> | Record<string, unknown>[];
}

const basePath = import.meta.env.BASE_URL;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const rssURL = new URL(`${basePath}rss.xml/`, Astro.site);
const sitemapURL = new URL(`${basePath}sitemap-index.xml`, Astro.site);
const defaultOgImageURL = new URL(`${basePath}og-cover.svg`, Astro.site);

const {
	title,
	description,
	image,
	ogType = 'website',
	noindex = false,
	publishedTime,
	modifiedTime,
	tags = [],
	structuredData,
} = Astro.props;

const ogImageURL = image
	? new URL(image.startsWith('http') ? image : `${basePath}${image.replace(/^\/+/, '')}`, Astro.site)
	: defaultOgImageURL;
const publishedISO = publishedTime ? new Date(publishedTime).toISOString() : null;
const modifiedISO = modifiedTime ? new Date(modifiedTime).toISOString() : null;
const baseURL = new URL(basePath, Astro.site).toString();
const searchURLTemplate = new URL(`${basePath}search/?q={search_term_string}`, Astro.site).toString();
const analyticsProvider = (import.meta.env.PUBLIC_ANALYTICS_PROVIDER || '').toLowerCase();
const plausibleDomain = import.meta.env.PUBLIC_PLAUSIBLE_DOMAIN;
const plausibleScriptURL =
	import.meta.env.PUBLIC_PLAUSIBLE_SCRIPT_URL || 'https://plausible.io/js/script.outbound-links.js';
const umamiWebsiteId = import.meta.env.PUBLIC_UMAMI_WEBSITE_ID;
const umamiScriptURL = import.meta.env.PUBLIC_UMAMI_SCRIPT_URL;
const usePlausible = analyticsProvider === 'plausible' && Boolean(plausibleDomain);
const useUmami = analyticsProvider === 'umami' && Boolean(umamiWebsiteId && umamiScriptURL);
const webSiteStructuredData = {
	'@context': 'https://schema.org',
	'@type': 'WebSite',
	name: SITE_TITLE,
	url: baseURL,
	description: SITE_DESCRIPTION,
	inLanguage: 'en-US',
	potentialAction: {
		'@type': 'SearchAction',
		target: searchURLTemplate,
		'query-input': 'required name=search_term_string',
	},
};
const additionalStructuredData = Array.isArray(structuredData)
	? structuredData
	: structuredData
		? [structuredData]
		: [];
const structuredDataItems = [webSiteStructuredData, ...additionalStructuredData];
---

<script is:inline>
	(() => {
		const key = 'learning-blog-theme';
		try {
			const stored = localStorage.getItem(key);
			const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
			const theme = stored === 'light' || stored === 'dark' ? stored : systemPrefersDark ? 'dark' : 'light';
			document.documentElement.dataset.theme = theme;
		} catch (_) {}
	})();
</script>

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/svg+xml" href={`${basePath}favicon.svg`} />
<link rel="sitemap" href={sitemapURL} />
<link rel="alternate" type="application/rss+xml" title={SITE_TITLE} href={rssURL} />
<meta name="generator" content={Astro.generator} />
<meta name="color-scheme" content="light dark" />
<meta name="robots" content={noindex ? 'noindex, nofollow' : 'index, follow'} />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={ogType} />
<meta property="og:url" content={canonicalURL} />
<meta property="og:site_name" content={SITE_TITLE} />
<meta property="og:locale" content="en_US" />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={ogImageURL} />
{publishedISO && <meta property="article:published_time" content={publishedISO} />}
{modifiedISO && <meta property="article:modified_time" content={modifiedISO} />}
{tags.map((tag) => <meta property="article:tag" content={tag} />)}

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={canonicalURL} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={ogImageURL} />

{
	usePlausible && <script defer data-domain={plausibleDomain} src={plausibleScriptURL}></script>
}
{useUmami && <script defer src={umamiScriptURL} data-website-id={umamiWebsiteId}></script>}
{
	useUmami && (
		<script is:inline>
			{`(() => {
				document.addEventListener(
					'click',
					(event) => {
						const target = event.target instanceof Element ? event.target.closest('a[href]') : null;
						if (!target) return;
						const href = target.getAttribute('href');
						if (!href) return;
						try {
							const destination = new URL(href, window.location.href);
							if (destination.origin === window.location.origin) return;
							if (window.umami && typeof window.umami.track === 'function') {
								window.umami.track('outbound_click', { href: destination.toString() });
							}
						} catch (_) {}
					},
					{ capture: true }
				);
			})();`}
		</script>
	)
}

{structuredDataItems.map((item) => <script type="application/ld+json" set:html={JSON.stringify(item)} />)}
