---
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import { getPublishedPosts, postPathFromId } from '../lib/posts';

function escapeXml(value) {
	return value
		.replaceAll('&', '&amp;')
		.replaceAll('<', '&lt;')
		.replaceAll('>', '&gt;')
		.replaceAll('"', '&quot;')
		.replaceAll("'", '&apos;');
}

const posts = await getPublishedPosts();
const basePath = import.meta.env.BASE_URL.replace(/\/$/, '');
const siteOrigin = Astro.site?.toString().replace(/\/$/, '') || '';

const rss = `<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
	<channel>
		<title>${escapeXml(SITE_TITLE)}</title>
		<description>${escapeXml(SITE_DESCRIPTION)}</description>
		<link>${siteOrigin}${basePath}/</link>
		<language>en-us</language>
${posts
	.map((post) => {
		const link = `${siteOrigin}${basePath}${postPathFromId(post.id)}`;
		const description = post.data.summary || post.data.description;
		const pubDate = post.data.pubDate instanceof Date ? post.data.pubDate : new Date(post.data.pubDate);
		return `		<item>
			<title>${escapeXml(post.data.title)}</title>
			<description>${escapeXml(description)}</description>
			<link>${escapeXml(link)}</link>
			<guid isPermaLink="true">${escapeXml(link)}</guid>
			<pubDate>${pubDate.toUTCString()}</pubDate>
		</item>`;
	})
	.join('\n')}
	</channel>
</rss>`;
---

<Fragment set:html={rss} />
