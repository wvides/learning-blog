---
import type { CollectionEntry } from 'astro:content';
import { SITE_TITLE } from '../consts';
import FormattedDate from '../components/FormattedDate.astro';
import { withBase } from '../lib/paths';
import { tagToSlug } from '../lib/tags';
import SiteShell from './SiteShell.astro';

type Props = CollectionEntry<'blog'>['data'];
type TocHeading = { depth: number; slug: string; text: string };
type PostLink = { title: string; href: string } | null;
type RelatedPostLink = { title: string; href: string; description: string };

const {
	title,
	description,
	pubDate,
	updatedDate,
	tags = [],
	heroImage,
	headings = [],
	readingTimeMinutes = 1,
	previous = null,
	next = null,
	related = [],
} = Astro.props as Props & {
	headings?: TocHeading[];
	readingTimeMinutes?: number;
	previous?: PostLink;
	next?: PostLink;
	related?: RelatedPostLink[];
};

const tocHeadings = headings.filter((heading) => heading.depth >= 2 && heading.depth <= 3);
const canonicalURL = new URL(Astro.url.pathname, Astro.site).toString();
const normalizedImage = heroImage || '/images/og-post.jpg';
const imageURL = normalizedImage.startsWith('http')
	? normalizedImage
	: new URL(`${import.meta.env.BASE_URL}${normalizedImage.replace(/^\/+/, '')}`, Astro.site).toString();
const publishedISO = new Date(pubDate).toISOString();
const modifiedISO = updatedDate ? new Date(updatedDate).toISOString() : publishedISO;
const articleStructuredData = {
	'@context': 'https://schema.org',
	'@type': 'BlogPosting',
	headline: title,
	description,
	mainEntityOfPage: canonicalURL,
	url: canonicalURL,
	image: [imageURL],
	datePublished: publishedISO,
	dateModified: modifiedISO,
	author: {
		'@type': 'Person',
		name: SITE_TITLE,
	},
	publisher: {
		'@type': 'Person',
		name: SITE_TITLE,
	},
	keywords: tags.join(', '),
};
---

<SiteShell
	title={title}
	description={description}
	ogType="article"
	image={heroImage || '/images/og-post.jpg'}
	publishedTime={pubDate}
	modifiedTime={updatedDate}
	tags={tags}
	structuredData={articleStructuredData}
>
	<article class="post">
		<header class="post-header">
			<div class="post-date">
				<FormattedDate date={pubDate} />
				{
					updatedDate && (
						<span class="updated-on">
							Updated <FormattedDate date={updatedDate} />
						</span>
					)
				}
				<span>{readingTimeMinutes} min read</span>
			</div>
			<h1>{title}</h1>
			<p>{description}</p>
			{
				tags.length > 0 && (
					<ul class="tags">
						{tags.map((tag) => <li><a href={withBase(`/tags/${tagToSlug(tag)}/`)}>{tag}</a></li>)}
					</ul>
				)
			}
		</header>
		{
			tocHeadings.length > 0 && (
				<aside class="toc" aria-label="Table of contents">
					<p>On this page</p>
					<ul>
						{tocHeadings.map((heading) => (
							<li class:list={{ sub: heading.depth === 3 }}>
								<a href={`#${heading.slug}`}>{heading.text}</a>
							</li>
						))}
					</ul>
				</aside>
			)
		}
		<div class="prose">
			<slot />
		</div>
		{
			related.length > 0 && (
				<section class="related-posts" aria-label="Related posts">
					<h2>Related posts</h2>
					<ul>
						{related.map((item) => (
							<li>
								<a href={withBase(item.href)}>
									<strong>{item.title}</strong>
									<span>{item.description}</span>
								</a>
							</li>
						))}
					</ul>
				</section>
			)
		}
		{
			(previous || next) && (
				<nav class="post-nav" aria-label="Post navigation">
					<div>
						{previous && (
							<a href={withBase(previous.href)}>
								<span>Older post</span>
								<strong>{previous.title}</strong>
							</a>
						)}
					</div>
					<div>
						{next && (
							<a href={withBase(next.href)}>
								<span>Newer post</span>
								<strong>{next.title}</strong>
							</a>
						)}
					</div>
				</nav>
			)
		}
	</article>
</SiteShell>

<style>
	.post {
		max-width: 760px;
		margin: 0 auto;
	}

	.post-header {
		margin-bottom: var(--space-6);
		padding-bottom: var(--space-5);
		border-bottom: 1px solid var(--line-subtle);
	}

	.post-date {
		display: flex;
		flex-wrap: wrap;
		gap: var(--space-3);
		margin-bottom: var(--space-3);
		font-size: 0.92rem;
		color: var(--text-muted);
	}

	.updated-on {
		font-style: italic;
	}

	.post-header h1 {
		margin-bottom: var(--space-3);
	}

	.post-header p {
		margin: 0;
	}

	.post-date > span {
		display: inline-flex;
		align-items: center;
		padding: 0.15rem 0.46rem;
		border-radius: 999px;
		border: 1px solid color-mix(in srgb, var(--line-subtle), transparent 25%);
		background: color-mix(in srgb, var(--panel-bg), white 26%);
	}

	.tags {
		display: flex;
		flex-wrap: wrap;
		gap: 0.35rem;
		list-style: none;
		margin: var(--space-4) 0 0;
		padding: 0;
	}

	.tags a {
		display: inline-flex;
		padding: 0.2rem 0.5rem;
		border-radius: 999px;
		font-size: 0.76rem;
		border: 1px solid color-mix(in srgb, var(--line-subtle), transparent 28%);
		background: color-mix(in srgb, var(--panel-bg), white 26%);
		text-decoration: none;
		color: var(--text-strong);
	}

	.tags a:hover {
		background: color-mix(in srgb, var(--line-subtle), transparent 34%);
	}

	.prose :global(p) {
		margin-bottom: var(--space-5);
	}

	.prose :global(h2),
	.prose :global(h3) {
		scroll-margin-top: 5.5rem;
	}

	.toc {
		margin-bottom: var(--space-5);
		padding: var(--space-4);
		border: 1px solid var(--line-subtle);
		border-radius: var(--radius-md);
		background: color-mix(in srgb, var(--panel-bg), white 15%);
	}

	.toc p {
		margin: 0 0 var(--space-3);
		font-weight: 600;
		font-size: 0.9rem;
		color: var(--text-strong);
	}

	.toc ul {
		list-style: none;
		margin: 0;
		padding: 0;
		display: grid;
		gap: 0.2rem;
	}

	.toc li.sub {
		padding-left: 0.7rem;
	}

	.toc a {
		display: inline-flex;
		align-items: center;
		padding: 0.14rem 0.32rem;
		border-radius: 0.4rem;
		text-decoration: none;
		font-size: 0.9rem;
		color: var(--text-muted);
	}

	.toc a:hover {
		color: var(--text-strong);
		background: color-mix(in srgb, var(--line-subtle), transparent 52%);
	}

	.post-nav {
		margin-top: var(--space-6);
		padding-top: var(--space-5);
		border-top: 1px solid var(--line-subtle);
		display: grid;
		grid-template-columns: repeat(2, minmax(0, 1fr));
		gap: var(--space-4);
	}

	.post-nav div:last-child {
		text-align: right;
	}

	.post-nav a {
		display: inline-flex;
		flex-direction: column;
		gap: 0.25rem;
		padding: 0.55rem 0.7rem;
		border-radius: var(--radius-sm);
		border: 1px solid color-mix(in srgb, var(--line-subtle), transparent 26%);
		background: color-mix(in srgb, var(--panel-bg), white 24%);
		text-decoration: none;
	}

	.post-nav span {
		font-size: 0.76rem;
		color: var(--text-muted);
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	.post-nav strong {
		font-size: 0.96rem;
		font-weight: 600;
		color: var(--text-strong);
	}

	.post-nav a:hover {
		border-color: color-mix(in srgb, var(--link), white 42%);
		background: color-mix(in srgb, var(--panel-bg), white 34%);
	}

	.related-posts {
		margin-top: var(--space-6);
		padding: var(--space-4);
		border: 1px solid var(--line-subtle);
		border-radius: var(--radius-md);
		background: color-mix(in srgb, var(--panel-bg), white 18%);
	}

	.related-posts h2 {
		font-size: 1.02rem;
		margin-top: 0;
		margin-bottom: var(--space-3);
	}

	.related-posts ul {
		list-style: none;
		margin: 0;
		padding: 0;
		display: grid;
		gap: var(--space-2);
	}

	.related-posts a {
		display: grid;
		gap: 0.2rem;
		padding: 0.45rem 0.55rem;
		border-radius: 0.6rem;
		text-decoration: none;
	}

	.related-posts a:hover {
		background: color-mix(in srgb, var(--line-subtle), transparent 34%);
	}

	.related-posts strong {
		font-size: 0.95rem;
		color: var(--text-strong);
	}

	.related-posts span {
		color: var(--text-muted);
		font-size: 0.88rem;
	}

	:root[data-theme="dark"] .post-date > span,
	:root[data-theme="dark"] .tags a,
	:root[data-theme="dark"] .post-nav a {
		background: color-mix(in srgb, var(--panel-bg), #1e5b67 36%);
		border-color: color-mix(in srgb, var(--line-subtle), #89c8d5 14%);
	}

	:root[data-theme="dark"] .related-posts {
		background: color-mix(in srgb, var(--panel-bg), #1b5460 40%);
		border-color: color-mix(in srgb, var(--line-subtle), #89c8d5 14%);
	}

	@media (max-width: 720px) {
		.post-nav {
			grid-template-columns: 1fr;
		}

		.post-nav div:last-child {
			text-align: left;
		}
	}
</style>
